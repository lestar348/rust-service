# Protocol Specification (MVP)

## Protocol Versioning
- `protocol_version: u16` is included in every RPC envelope.
- Backward compatibility policy (MVP):
  - same major = compatible
  - bump major on breaking changes

---

## Common RPC Envelope

### Logical Model
- Request:
  - `request_id: u64` (generated by caller)
  - `protocol_version: u16`
  - `service: string`
  - `method: string`
  - `payload: bytes`
  - `timeout_ms: u64`
- Response:
  - `request_id: u64` (echo)
  - `status: ok|error`
  - `error_code: string` (if error)
  - `payload: bytes`

### Encoding
Choose one via config:
- JSON (dev-friendly)
- CBOR (embedded-friendly)

MVP default: JSON in dev, CBOR allowed for production.

---

## HTTP Transport

### RPC Endpoint
- `POST /rpc`
- Body: encoded RPC Request envelope
- Response: encoded RPC Response envelope
- Headers:
  - `Content-Type: application/json` or `application/cbor`
  - `X-Request-Id` optional (debug)

### Events Channel (choose one)
#### Option A: WebSocket
- `GET /events` upgrade to WS
- Messages: `TransportEvent` envelope:
  - `topic: string`
  - `payload: bytes` (encoded as base64 if JSON)

#### Option B: SSE (server -> client only)
- `GET /events/sse`
- SSE `event: <topic>` and `data: <payload>` (base64 if binary)

MVP recommendation: WS if bidirectional or future-proofing matters; SSE if minimal.

### Topics (MVP)
- `transport/status` (optional)
- `hello/announce` (optional example)
- feature-specific topics are namespaced: `<service>/<something>`

---

## BLE Transport (GATT)

## Service & Characteristics (UUID placeholders)
- Primary Service UUID: `XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX`

Characteristics:
1) `rpc_rx` (Write/WriteWithoutResponse)
- Client writes request chunks.

2) `rpc_tx` (Notify)
- Device notifies response chunks.

3) `events_tx` (Notify)
- Device notifies event messages.

> Exact UUIDs фиксируются один раз и не меняются без bump major.

---

## BLE Message Framing

### Constraints
- BLE MTU varies; assume small payloads and implement chunking.
- Goal: support payload sizes up to at least 8–32 KB (configurable).

### Frame Header (binary)
Each chunk carries:
- `msg_id: u32`
- `kind: u8` (0=request, 1=response, 2=event)
- `flags: u8` (bit0=first, bit1=last)
- `seq: u16` (chunk sequence starting at 0)
- `total_len: u32` (only required on first chunk; else 0)
- `chunk_len: u16`
- `chunk_bytes[chunk_len]`

### Reassembly Rules
- On `first` chunk:
  - allocate buffer of `total_len`
  - start timer `reassembly_timeout_ms`
- On each chunk:
  - validate `seq` ordering (strict for MVP)
  - append bytes
- On `last` chunk:
  - validate accumulated == total_len
  - emit full message to upper layer

### Timeouts & Errors
- If missing chunk or timeout => drop message and emit error event:
  - topic: `transport/error`
  - payload: `{ kind, msg_id, reason }`

---

## Feature API: Hello World

### Service/Method
- `service = "hello"`
- `method  = "get"`

### Request payload
- empty bytes (MVP)

### Response payload
- UTF-8 string: `"<RFC3339 datetime> hello world"`

Example:
- `2025-12-21T18:45:12Z hello world`

---

## Error Codes (MVP)
- `unsupported_service`
- `unsupported_method`
- `decode_error`
- `timeout`
- `internal_error`